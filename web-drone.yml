---
kind: pipeline
type: docker
name: lint-test

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: lint-test
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn run lint

trigger:
  ref:
  - refs/heads/master
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
type: docker
name: changelog

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: clone
  pull: always
  image: plugins/git-action:1
  settings:
    actions:
    - clone
    branch: master
    netrc_machine: github.com
    netrc_password:
      from_secret: github_token
    netrc_username:
      from_secret: github_username
    path: /drone/src
    remote: https://github.com/abc

- name: generate
  pull: always
  image: toolhippie/calens:latest
  commands:
  - calens >| CHANGELOG.md

- name: diff
  pull: always
  image: owncloud/alpine:latest
  commands:
  - git diff

- name: output
  pull: always
  image: toolhippie/calens:latest
  commands:
  - cat CHANGELOG.md

- name: publish
  pull: always
  image: plugins/git-action:1
  settings:
    actions:
    - commit
    - push
    author_email: devops@owncloud.com
    author_name: ownClouders
    branch: master
    message: Automated changelog update [skip ci]
    netrc_machine: github.com
    netrc_password:
      from_secret: github_token
    netrc_username:
      from_secret: github_username
  when:
    ref:
      exclude:
      - refs/pull/**
      - refs/tags/**

trigger:
  ref:
  - refs/heads/master
  - refs/pull/**

---
kind: pipeline
type: docker
name: website

platform:
  os: linux
  arch: amd64

steps:
- name: prepare
  image: owncloudci/alpine:latest
  commands:
  - "\tmake docs-copy"

- name: test
  image: owncloudci/hugo:0.71.0
  commands:
  - cd hugo
  - "\thugo"

- name: list
  image: owncloudci/alpine:latest
  commands:
  - tree hugo/public

- name: publish
  pull: always
  image: plugins/gh-pages:1
  settings:
    pages_directory: docs/
    password:
      from_secret: github_token
    target_branch: docs
    username:
      from_secret: github_username
  when:
    ref:
      exclude:
      - refs/pull/**

- name: downstream
  image: plugins/downstream
  settings:
    repositories:
    - owncloud/owncloud.github.io@source
    server: https://drone.owncloud.com/
    token:
      from_secret: drone_token
  when:
    ref:
      exclude:
      - refs/pull/**

trigger:
  ref:
  - refs/heads/master
  - refs/pull/**

---
kind: pipeline
type: docker
name: unit-tests

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn test:unit

trigger:
  ref:
  - refs/heads/master
  - refs/pull/**

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: cache-ocis

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: build-ocis
  pull: always
  image: owncloudci/golang:1.16
  commands:
  - ./tests/drone/build-ocis.sh

- name: upload-ocis-bin
  pull: if-not-exists
  image: plugins/s3
  settings:
    access_key:
      from_secret: cache_s3_access_key
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    secret_key:
      from_secret: cache_s3_secret_key
    source: /var/www/owncloud/ocis-build/**/*
    strip_prefix: /var/www/owncloud/ocis-build
    target: /web/ocis-build/

- name: list-ocis-bin-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc find s3/owncloud/web/ocis-build
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

trigger:
  ref:
  - refs/heads/master
  - refs/tags/**
  - refs/pull/**

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIBasic-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIAccount tests/acceptance/features/webUILogin tests/acceptance/features/webUIPreview tests/acceptance/features/webUIPrivateLinks tests/acceptance/features/webUIAdminSettings tests/acceptance/features/webUIComments tests/acceptance/features/webUITags tests/acceptance/features/webUIWebdavLockProtection tests/acceptance/features/webUIWebdavLocks "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUICreate-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUICreateFilesFolders "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUICreate</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUICreate
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUICreate</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUICreate
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIDelete-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIDeleteFilesFolders "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIDelete</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIDelete
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIDelete</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIDelete
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIRename-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIRenameFiles tests/acceptance/features/webUIRenameFolders "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIRename</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIRename
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIRename</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIRename
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUISharingBasic-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUISharingAcceptShares tests/acceptance/features/webUISharingAcceptSharesToRoot "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUISharingBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUISharingBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: Favorites-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUIFavorites
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>Favorites</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: Favorites
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Favorites</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: Favorites
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: MarkdownEditor-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUIMarkdownEditor
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>MarkdownEditor</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: MarkdownEditor
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>MarkdownEditor</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: MarkdownEditor
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIFiles1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIFiles tests/acceptance/features/webUIFilesActionMenu tests/acceptance/features/webUIFilesCopy "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIFiles1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIFiles1
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIFiles1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIFiles1
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIFiles2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIFilesDetails tests/acceptance/features/webUIFilesList tests/acceptance/features/webUIFilesSearch "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIFiles2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIFiles2
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIFiles2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIFiles2
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: Move-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUIMoveFilesFolders
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>Move</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: Move
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Move</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: Move
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIResharing-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIResharing1 tests/acceptance/features/webUIResharing2 "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIResharing</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIResharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUIResharing</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIResharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: ResharingToRoot-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUIResharingToRoot
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>ResharingToRoot</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: ResharingToRoot
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>ResharingToRoot</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: ResharingToRoot
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: RestrictSharing-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUIRestrictSharing
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>RestrictSharing</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: RestrictSharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RestrictSharing</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: RestrictSharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingAutocompletion-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingAutocompletion
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingAutocompletion</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingAutocompletion
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingAutocompletion</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingAutocompletion
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingFilePermissionMultipleUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingFilePermissionMultipleUsers
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingFilePermissionMultipleUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFilePermissionMultipleUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFilePermissionMultipleUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFilePermissionMultipleUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingFilePermissionsGroups-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingFilePermissionsGroups
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingFilePermissionsGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFilePermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFilePermissionsGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFilePermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingFolderAdvancedPermissionMU-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingFolderAdvancedPermissionMultipleUsers
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingFolderAdvancedPermissionMU</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFolderAdvancedPermissionMU
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFolderAdvancedPermissionMU</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFolderAdvancedPermissionMU
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingFolderAdvPermissionsGrp-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingFolderAdvancedPermissionsGroups
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingFolderAdvPermissionsGrp</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFolderAdvPermissionsGrp
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFolderAdvPermissionsGrp</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFolderAdvPermissionsGrp
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingFolderPermissionMultipleUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingFolderPermissionMultipleUsers
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingFolderPermissionMultipleUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFolderPermissionMultipleUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFolderPermissionMultipleUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFolderPermissionMultipleUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingFolderPermissionsGroups-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingFolderPermissionsGroups
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingFolderPermissionsGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFolderPermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFolderPermissionsGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingFolderPermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalGroups-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalGroups
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalGroupsEdgeCases-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalGroupsEdgeCases
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalGroupsEdgeCases</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsEdgeCases
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalGroupsEdgeCases</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsEdgeCases
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalGroupsSharingIndicator-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalGroupsSharingIndicator
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalGroupsSharingIndicator</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsSharingIndicator
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalGroupsSharingIndicator</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsSharingIndicator
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalGroupsRoot-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalGroupsToRoot
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalGroupsRoot</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsRoot
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalGroupsRoot</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsRoot
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalGroupsRootEdgeCases-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalGroupsToRootEdgeCases
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalGroupsRootEdgeCases</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsRootEdgeCases
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalGroupsRootEdgeCases</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsRootEdgeCases
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalGroupsRootSharingIndicator-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalGroupsToRootSharingIndicator
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalGroupsRootSharingIndicator</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsRootSharingIndicator
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalGroupsRootSharingIndicator</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalGroupsRootSharingIndicator
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUISharingInternalUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUISharingInternalUsers tests/acceptance/features/webUISharingInternalUsersCollaborator tests/acceptance/features/webUISharingInternalUsersShareWithPage "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUISharingInternalUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingInternalUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUISharingInternalUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingInternalUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalUsersBlacklisted-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalUsersBlacklisted
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalUsersBlacklisted</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersBlacklisted
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalUsersBlacklisted</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersBlacklisted
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalUsersExpire-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalUsersExpire
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalUsersExpire</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersExpire
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalUsersExpire</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersExpire
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalUsersExpireToRoot-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalUsersExpireToRoot
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalUsersExpireToRoot</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersExpireToRoot
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalUsersExpireToRoot</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersExpireToRoot
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalUsersSharingIndicator-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalUsersSharingIndicator
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalUsersSharingIndicator</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersSharingIndicator
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalUsersSharingIndicator</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersSharingIndicator
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUISharingInternalUsersRoot1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalUsersToRoot
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUISharingInternalUsersRoot1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingInternalUsersRoot1
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUISharingInternalUsersRoot1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingInternalUsersRoot1
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUISharingInternalUsersRoot2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUISharingInternalUsersToRootCollaborator tests/acceptance/features/webUISharingInternalUsersToRootPreviews tests/acceptance/features/webUISharingInternalUsersToRootShareWithPage "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUISharingInternalUsersRoot2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingInternalUsersRoot2
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUISharingInternalUsersRoot2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingInternalUsersRoot2
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalUsersRootBlacklisted-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalUsersToRootBlacklisted
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalUsersRootBlacklisted</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersRootBlacklisted
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalUsersRootBlacklisted</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersRootBlacklisted
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingInternalUsersRootSharingIndicator-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingInternalUsersToRootSharingIndicator
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingInternalUsersRootSharingIndicator</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersRootSharingIndicator
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalUsersRootSharingIndicator</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingInternalUsersRootSharingIndicator
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingPermissionsUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingPermissionsUsers
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingPermissionsUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPermissionsUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPermissionsUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPermissionsUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingPermissionToRoot-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingPermissionToRoot
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingPermissionToRoot</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPermissionToRoot
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPermissionToRoot</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPermissionToRoot
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingPublicBasic-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingPublicBasic
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingPublicBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPublicBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPublicBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPublicBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingPublicManagement-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingPublicManagement
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingPublicManagement</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPublicManagement
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPublicManagement</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPublicManagement
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingPublicDifferentRoles-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingPublicDifferentRoles
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingPublicDifferentRoles</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPublicDifferentRoles
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPublicDifferentRoles</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPublicDifferentRoles
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingPublicExpire-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingPublicExpire
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>SharingPublicExpire</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPublicExpire
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPublicExpire</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: SharingPublicExpire
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: TrashbinDelete-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUITrashbinDelete
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>TrashbinDelete</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: TrashbinDelete
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>TrashbinDelete</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: TrashbinDelete
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: TrashbinFilesFolders-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUITrashbinFilesFolders
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>TrashbinFilesFolders</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: TrashbinFilesFolders
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>TrashbinFilesFolders</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: TrashbinFilesFolders
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: TrashbinRestore-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUITrashbinRestore
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>TrashbinRestore</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: TrashbinRestore
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>TrashbinRestore</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: TrashbinRestore
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: Upload-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_CONTEXT: webUIUpload
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>Upload</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: Upload
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Upload</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: Upload
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUINotificationBasic-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: install-notifications-app-on-server
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/notifications.git /var/www/owncloud/server/apps/notifications
  - cd /var/www/owncloud/server
  - php occ a:e notifications
  - php occ a:l

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUINotifications "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUINotificationBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUINotificationBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUINotificationBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUINotificationBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUISharingNotifications-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: install-notifications-app-on-server
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/notifications.git /var/www/owncloud/server/apps/notifications
  - cd /var/www/owncloud/server
  - php occ a:e notifications
  - php occ a:l

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUISharingNotifications tests/acceptance/features/webUISharingNotificationsToRoot "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
    VISUAL_TEST: true
    WEB_UI_CONFIG: /var/www/owncloud/web/dist/config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd oc10
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUISharingNotifications</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd oc10
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/oc10/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingNotifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>webUISharingNotifications</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUISharingNotifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingExternal-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: install-notifications-app-on-server
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/notifications.git /var/www/owncloud/server/apps/notifications
  - cd /var/www/owncloud/server
  - php occ a:e notifications
  - php occ a:l

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated/
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: setup-fed-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/federated/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/federated/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: fix-permissions-federated
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/federated
  - chown www-data * -R

- name: owncloud-federated-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    REMOTE_BACKEND_HOST: http://federated
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingExternal
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

- name: federated
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated/

- name: mysql-federated
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: SharingExternalRoot-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: install-notifications-app-on-server
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/notifications.git /var/www/owncloud/server/apps/notifications
  - cd /var/www/owncloud/server
  - php occ a:e notifications
  - php occ a:l

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated/
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: setup-fed-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/federated/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/federated/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: fix-permissions-federated
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/federated
  - chown www-data * -R

- name: owncloud-federated-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    REMOTE_BACKEND_HOST: http://federated
    SERVER_HOST: http://web
    TEST_CONTEXT: webUISharingExternalToRoot
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

- name: federated
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated/

- name: mysql-federated
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: XGAPortrait1-Notifications-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: install-notifications-app-on-server
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/notifications.git /var/www/owncloud/server/apps/notifications
  - cd /var/www/owncloud/server
  - php occ a:e notifications
  - php occ a:l

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-XGA-with-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 768x1024
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUINotifications tests/acceptance/features/webUISharingNotifications tests/acceptance/features/webUISharingNotificationsToRoot "
    TEST_TAGS: "@smokeTest and not @skipOnXGAPortraitResolution and not @skip and not @skipOnOC10"
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: XGAPortrait1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 768x1024
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIAccount tests/acceptance/features/webUICreateFilesFolders tests/acceptance/features/webUIDeleteFilesFolders tests/acceptance/features/webUIFavorites tests/acceptance/features/webUIFiles tests/acceptance/features/webUIFilesActionMenu tests/acceptance/features/webUIFilesCopy tests/acceptance/features/webUIFilesDetails tests/acceptance/features/webUIFilesList tests/acceptance/features/webUIFilesSearch tests/acceptance/features/webUILogin tests/acceptance/features/webUIPreview tests/acceptance/features/webUIPrivateLinks tests/acceptance/features/webUIRenameFiles tests/acceptance/features/webUIRenameFolders tests/acceptance/features/webUIRestrictSharing tests/acceptance/features/webUISharingAcceptShares tests/acceptance/features/webUISharingAcceptSharesToRoot tests/acceptance/features/webUIAdminSettings tests/acceptance/features/webUIComments tests/acceptance/features/webUITags tests/acceptance/features/webUIWebdavLockProtection tests/acceptance/features/webUIWebdavLocks "
    TEST_TAGS: "@smokeTest and not @skipOnXGAPortraitResolution and not @skip and not @skipOnOC10"
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: XGAPortrait2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 768x1024
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIMoveFilesFolders tests/acceptance/features/webUIResharing1 tests/acceptance/features/webUIResharing2 tests/acceptance/features/webUIResharingToRoot tests/acceptance/features/webUISharingAutocompletion tests/acceptance/features/webUISharingFilePermissionMultipleUsers tests/acceptance/features/webUISharingFilePermissionsGroups tests/acceptance/features/webUISharingFolderAdvancedPermissionMultipleUsers tests/acceptance/features/webUISharingFolderAdvancedPermissionsGroups tests/acceptance/features/webUISharingFolderPermissionMultipleUsers tests/acceptance/features/webUISharingFolderPermissionsGroups tests/acceptance/features/webUISharingInternalGroups tests/acceptance/features/webUISharingInternalGroupsEdgeCases tests/acceptance/features/webUISharingInternalGroupsSharingIndicator tests/acceptance/features/webUISharingInternalGroupsToRoot tests/acceptance/features/webUISharingInternalGroupsToRootEdgeCases tests/acceptance/features/webUISharingInternalGroupsToRootSharingIndicator tests/acceptance/features/webUISharingInternalUsers tests/acceptance/features/webUISharingInternalUsersCollaborator tests/acceptance/features/webUISharingInternalUsersShareWithPage tests/acceptance/features/webUISharingInternalUsersBlacklisted tests/acceptance/features/webUISharingInternalUsersExpire tests/acceptance/features/webUISharingInternalUsersExpireToRoot tests/acceptance/features/webUISharingInternalUsersSharingIndicator tests/acceptance/features/webUISharingInternalUsersToRoot tests/acceptance/features/webUISharingInternalUsersToRootCollaborator tests/acceptance/features/webUISharingInternalUsersToRootPreviews tests/acceptance/features/webUISharingInternalUsersToRootShareWithPage tests/acceptance/features/webUISharingInternalUsersToRootBlacklisted tests/acceptance/features/webUISharingInternalUsersToRootSharingIndicator tests/acceptance/features/webUISharingPermissionsUsers tests/acceptance/features/webUISharingPermissionToRoot tests/acceptance/features/webUISharingPublicBasic tests/acceptance/features/webUISharingPublicManagement tests/acceptance/features/webUISharingPublicDifferentRoles tests/acceptance/features/webUISharingPublicExpire tests/acceptance/features/webUITrashbinDelete tests/acceptance/features/webUITrashbinFilesFolders tests/acceptance/features/webUITrashbinRestore tests/acceptance/features/webUIUpload "
    TEST_TAGS: "@smokeTest and not @skipOnXGAPortraitResolution and not @skip and not @skipOnOC10"
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: iPhone1-Notifications-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: install-notifications-app-on-server
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/notifications.git /var/www/owncloud/server/apps/notifications
  - cd /var/www/owncloud/server
  - php occ a:e notifications
  - php occ a:l

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-Iphone-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 375x812
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUINotifications tests/acceptance/features/webUISharingNotifications tests/acceptance/features/webUISharingNotificationsToRoot "
    TEST_TAGS: "@smokeTest and not @skipOnIphoneResolution and not @skip and not @skipOnOC10"
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: iPhone1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-Iphone-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 375x812
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIAccount tests/acceptance/features/webUICreateFilesFolders tests/acceptance/features/webUIDeleteFilesFolders tests/acceptance/features/webUIFavorites tests/acceptance/features/webUIFiles tests/acceptance/features/webUIFilesActionMenu tests/acceptance/features/webUIFilesCopy tests/acceptance/features/webUIFilesDetails tests/acceptance/features/webUIFilesList tests/acceptance/features/webUIFilesSearch tests/acceptance/features/webUILogin tests/acceptance/features/webUIPreview tests/acceptance/features/webUIPrivateLinks tests/acceptance/features/webUIRenameFiles tests/acceptance/features/webUIRenameFolders tests/acceptance/features/webUIRestrictSharing tests/acceptance/features/webUISharingAcceptShares tests/acceptance/features/webUISharingAcceptSharesToRoot tests/acceptance/features/webUIAdminSettings tests/acceptance/features/webUIComments tests/acceptance/features/webUITags tests/acceptance/features/webUIWebdavLockProtection tests/acceptance/features/webUIWebdavLocks "
    TEST_TAGS: "@smokeTest and not @skipOnIphoneResolution and not @skip and not @skipOnOC10"
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: iPhone2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://web
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set web.baseUrl --value="http://web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-Iphone-oc10-server-oauth2-login.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 375x812
    SERVER_HOST: http://web
    TEST_PATHS: "tests/acceptance/features/webUIMoveFilesFolders tests/acceptance/features/webUIResharing1 tests/acceptance/features/webUIResharing2 tests/acceptance/features/webUIResharingToRoot tests/acceptance/features/webUISharingAutocompletion tests/acceptance/features/webUISharingFilePermissionMultipleUsers tests/acceptance/features/webUISharingFilePermissionsGroups tests/acceptance/features/webUISharingFolderAdvancedPermissionMultipleUsers tests/acceptance/features/webUISharingFolderAdvancedPermissionsGroups tests/acceptance/features/webUISharingFolderPermissionMultipleUsers tests/acceptance/features/webUISharingFolderPermissionsGroups tests/acceptance/features/webUISharingInternalGroups tests/acceptance/features/webUISharingInternalGroupsEdgeCases tests/acceptance/features/webUISharingInternalGroupsSharingIndicator tests/acceptance/features/webUISharingInternalGroupsToRoot tests/acceptance/features/webUISharingInternalGroupsToRootEdgeCases tests/acceptance/features/webUISharingInternalGroupsToRootSharingIndicator tests/acceptance/features/webUISharingInternalUsers tests/acceptance/features/webUISharingInternalUsersExpire tests/acceptance/features/webUISharingInternalUsersCollaborator tests/acceptance/features/webUISharingInternalUsersShareWithPage tests/acceptance/features/webUISharingInternalUsersSharingIndicator tests/acceptance/features/webUISharingInternalUsersToRootCollaborator tests/acceptance/features/webUISharingInternalUsersToRootPreviews tests/acceptance/features/webUISharingInternalUsersToRootShareWithPage tests/acceptance/features/webUISharingInternalUsersToRootSharingIndicator tests/acceptance/features/webUISharingInternalUsersExpireToRoot tests/acceptance/features/webUISharingInternalUsersToRoot tests/acceptance/features/webUISharingInternalUsersToRootBlacklisted tests/acceptance/features/webUISharingPermissionsUsers tests/acceptance/features/webUISharingPermissionToRoot tests/acceptance/features/webUISharingPublicBasic tests/acceptance/features/webUISharingPublicManagement tests/acceptance/features/webUISharingPublicDifferentRoles tests/acceptance/features/webUISharingPublicExpire tests/acceptance/features/webUITrashbinDelete tests/acceptance/features/webUITrashbinFilesFolders tests/acceptance/features/webUITrashbinRestore tests/acceptance/features/webUIUpload "
    TEST_TAGS: "@smokeTest and not @skipOnIphoneResolution and not @skip and not @skipOnOC10"
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISBasic-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUILogin tests/acceptance/features/webUINotifications tests/acceptance/features/webUIPrivateLinks tests/acceptance/features/webUIPreview tests/acceptance/features/webUIAccount tests/acceptance/features/webUIAdminSettings tests/acceptance/features/webUIComments tests/acceptance/features/webUITags tests/acceptance/features/webUIWebdavLockProtection tests/acceptance/features/webUIWebdavLocks "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISCreate-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUICreateFilesFolders "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISCreate</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISCreate
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISDelete-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUIDeleteFilesFolders "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISDelete</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISDelete
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISRename-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUIRenameFiles tests/acceptance/features/webUIRenameFolders "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISRename</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISRename
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISSharingBasic-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUISharingAcceptShares "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISSharingBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISSharingBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISRestrictSharing-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUIRestrictSharing "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISRestrictSharing</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISRestrictSharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISSharingNotifications-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUISharingNotifications "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISSharingNotifications</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISSharingNotifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISFavorites-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUIFavorites
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISFavorites</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISFavorites
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISMarkdownEditor-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUIMarkdownEditor
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISMarkdownEditor</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISMarkdownEditor
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISFiles1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUIFiles tests/acceptance/features/webUIFilesActionMenu tests/acceptance/features/webUIFilesCopy "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISFiles1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISFiles1
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISFiles2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUIFilesDetails tests/acceptance/features/webUIFilesSearch "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISFiles2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISFiles2
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: webUIOCISFiles3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUIFilesList "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>webUIOCISFiles3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: webUIOCISFiles3
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingAutocompletion-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingAutocompletion
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingAutocompletion</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingAutocompletion
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingInternalGroups-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUISharingInternalGroups tests/acceptance/features/webUISharingInternalGroupsEdgeCases tests/acceptance/features/webUISharingInternalGroupsSharingIndicator "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingInternalGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingInternalGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingInternalUsers1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUISharingInternalUsers "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingInternalUsers1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingInternalUsers1
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingInternalUsers2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUISharingInternalUsersBlacklisted tests/acceptance/features/webUISharingInternalUsersCollaborator tests/acceptance/features/webUISharingInternalUsersShareWithPage tests/acceptance/features/webUISharingInternalUsersSharingIndicator "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingInternalUsers2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingInternalUsers2
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingInternalUsersExpire-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingInternalUsersExpire
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingInternalUsersExpire</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingInternalUsersExpire
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingPermissionsUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingPermissionsUsers
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingPermissionsUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingPermissionsUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingFilePermissionsGroups-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingFilePermissionsGroups
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingFilePermissionsGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingFilePermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingFolderPermissionsGroups-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingFolderPermissionsGroups
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingFolderPermissionsGroups</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingFolderPermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingFolderAdvPermissionsGrp-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingFolderAdvancedPermissionsGroups
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingFolderAdvPermissionsGrp</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingFolderAdvPermissionsGrp
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISResharing1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUIResharing1 "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISResharing1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISResharing1
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISResharing2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_PATHS: "tests/acceptance/features/webUIResharing2 "
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISResharing2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISResharing2
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingPublicBasic-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingPublicBasic
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingPublicBasic</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingPublicBasic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingPublicManagement-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingPublicManagement
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingPublicManagement</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingPublicManagement
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingPublicExpire-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingPublicExpire
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingPublicExpire</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingPublicExpire
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingPublicDifferentRoles-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingPublicDifferentRoles
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingPublicDifferentRoles</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingPublicDifferentRoles
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISTrashbinDelete-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUITrashbinDelete
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISTrashbinDelete</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISTrashbinDelete
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISTrashbinFilesFolders-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUITrashbinFilesFolders
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISTrashbinFilesFolders</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISTrashbinFilesFolders
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISTrashbinRestore-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUITrashbinRestore
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISTrashbinRestore</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISTrashbinRestore
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISUpload-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUIUpload
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISUpload</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISUpload
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingFilePermissionMultipleUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingFilePermissionMultipleUsers
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingFilePermissionMultipleUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingFilePermissionMultipleUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingFolderPermissionMultipleUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingFolderPermissionMultipleUsers
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingFolderPermissionMultipleUsers</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingFolderPermissionMultipleUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISSharingFolderAdvancedPermissionMU-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUISharingFolderAdvancedPermissionMultipleUsers
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISSharingFolderAdvancedPermissionMU</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISSharingFolderAdvancedPermissionMU
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISMove-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUIMoveFilesFolders
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISMove</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISMove
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: OCISJourney-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - cp tests/drone/config-oc10-oauth.json dist/config.json
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: get-ocis-from-cache
  image: minio/mc:RELEASE.2020-12-10T01-26-17Z
  commands:
  - source /var/www/owncloud/web/.drone.env
  - mkdir -p /var/www/owncloud/ocis-build
  - mc alias set s3 $MC_HOST $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY
  - mc mirror s3/owncloud/web/ocis-build/$OCIS_COMMITID /var/www/owncloud/ocis-build/
  - chmod +x /var/www/owncloud/ocis-build/ocis
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
    MC_HOST:
      from_secret: cache_s3_endpoint
  failure: ignore

- name: ocis
  pull: always
  image: owncloudci/golang:1.16
  detach: true
  commands:
  - cd /var/www/owncloud/ocis-build
  - mkdir -p /srv/app/tmp/ocis/owncloud/data/
  - mkdir -p /srv/app/tmp/ocis/storage/users/
  - ./ocis server
  environment:
    ACCOUNTS_DATA_PATH: /srv/app/tmp/ocis-accounts/
    IDP_IDENTIFIER_REGISTRATION_CONF: /srv/config/drone/identifier-registration.yml
    OCIS_URL: https://ocis:9200
    PROXY_ENABLE_BASIC_AUTH: true
    PROXY_OIDC_INSECURE: true
    STORAGE_DRIVER_LOCAL_ROOT: /srv/app/tmp/ocis/local/root
    STORAGE_DRIVER_OCIS_ROOT: /srv/app/tmp/ocis/storage/users
    STORAGE_DRIVER_OWNCLOUD_DATADIR: /srv/app/tmp/ocis/owncloud/data
    STORAGE_DRIVER_OWNCLOUD_REDIS_ADDR: redis:6379
    STORAGE_HOME_DATA_SERVER_URL: http://ocis:9155/data
    STORAGE_HOME_DRIVER: owncloud
    STORAGE_METADATA_ROOT: /srv/app/tmp/ocis/metadata
    STORAGE_USERS_DATA_SERVER_URL: http://ocis:9158/data
    STORAGE_USERS_DRIVER: owncloud
    WEB_ASSET_PATH: /var/www/owncloud/web/dist
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: setup-skeleton-files
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone https://github.com/owncloud/testing.git /srv/app/testing
  volumes:
  - name: gopath
    path: /srv/app

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: https://ocis:9200
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-ocis-server-owncloud-storage.md
    LOCAL_UPLOAD_DIR: /uploads
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    OCIS_REVA_DATA_ROOT: /srv/app/tmp/ocis/owncloud/data/
    RUN_ON_OCIS: true
    SERVER_HOST: https://ocis:9200
    TESTING_DATA_DIR: /srv/app/testing/data/
    TEST_CONTEXT: webUIUserJourney
    TEST_TAGS: not @skip and not @skipOnOCIS and not @notToImplementOnOCIS
    VISUAL_TEST: true
    WEB_UI_CONFIG: /srv/config/drone/ocis-config.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: list screenshots-visual
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - ls -laR /var/www/owncloud/web/tests/vrt
  when:
    status:
    - failure

- name: upload-diff-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/diff/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: upload-latest-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/vrt/latest/**/*
    strip_prefix: /var/www/owncloud/web/tests/vrt
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment-vrt
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/vrt/diff
  - cd ocis
  - ls -la
  - "echo \"<details><summary>:boom: Visual regression tests <strong>OCISJourney</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - "echo \"Diff Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/diff/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - cd ../../latest
  - cd ocis
  - "echo \"Actual Image: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/latest/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"Comparing Against: </br>\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f](https://raw.githubusercontent.com/owncloud/web/master/tests/vrt/baseline/ocis/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: OCISJourney
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: redis
  pull: always
  image: redis:6-alpine

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- cache-ocis
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: oc10-integration-notifications-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web-integration-app
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-web-integration-app
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - mkdir apps-external/web
  - cp /srv/config/drone/config-oc10-integration-app-openid.json config/config.json
  - cp /var/www/owncloud/web/packages/web-integration-oc10/* apps-external/web -r
  - cp /var/www/owncloud/web/dist/* apps-external/web -r
  - ls -la apps-external/web
  - cat config/config.json
  volumes:
  - name: configs
    path: /srv/config

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:e web
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set enable_previews --type=boolean --value=false
  - php occ config:system:set web.baseUrl --value="http://owncloud/index.php/apps/web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: install-notifications-app-on-server
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/notifications.git /var/www/owncloud/server/apps/notifications
  - cd /var/www/owncloud/server
  - php occ a:e notifications
  - php occ a:l

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://owncloud/index.php/apps/web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login-and-web-integration-app.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://owncloud/index.php/apps/web/index.html
    TEST_PATHS: "tests/acceptance/features/webUINotifications tests/acceptance/features/webUISharingNotifications tests/acceptance/features/webUISharingNotificationsToRoot "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin and @smokeTest
    WEB_UI_CONFIG: /srv/config/drone/config-oc10-integration-app-oauth.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>oc10-integration-notifications</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: oc10-integration-notifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: IntegrationApp1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web-integration-app
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-web-integration-app
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - mkdir apps-external/web
  - cp /srv/config/drone/config-oc10-integration-app-openid.json config/config.json
  - cp /var/www/owncloud/web/packages/web-integration-oc10/* apps-external/web -r
  - cp /var/www/owncloud/web/dist/* apps-external/web -r
  - ls -la apps-external/web
  - cat config/config.json
  volumes:
  - name: configs
    path: /srv/config

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:e web
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set enable_previews --type=boolean --value=false
  - php occ config:system:set web.baseUrl --value="http://owncloud/index.php/apps/web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://owncloud/index.php/apps/web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login-and-web-integration-app.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://owncloud/index.php/apps/web/index.html
    TEST_PATHS: "tests/acceptance/features/webUIAccount tests/acceptance/features/webUICreateFilesFolders tests/acceptance/features/webUIDeleteFilesFolders tests/acceptance/features/webUIFavorites tests/acceptance/features/webUIFiles tests/acceptance/features/webUIFilesActionMenu tests/acceptance/features/webUIFilesCopy tests/acceptance/features/webUIFilesDetails tests/acceptance/features/webUIFilesList tests/acceptance/features/webUIFilesSearch tests/acceptance/features/webUILogin tests/acceptance/features/webUIPreview tests/acceptance/features/webUIPrivateLinks tests/acceptance/features/webUIRenameFiles tests/acceptance/features/webUIRenameFolders tests/acceptance/features/webUIRestrictSharing tests/acceptance/features/webUISharingAcceptShares tests/acceptance/features/webUISharingAcceptSharesToRoot tests/acceptance/features/webUIAdminSettings tests/acceptance/features/webUIComments tests/acceptance/features/webUITags tests/acceptance/features/webUIWebdavLockProtection tests/acceptance/features/webUIWebdavLocks "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin and @smokeTest
    WEB_UI_CONFIG: /srv/config/drone/config-oc10-integration-app-oauth.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>IntegrationApp1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: IntegrationApp1
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: IntegrationApp2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: build-web-integration-app
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn build
  - mkdir -p /srv/config
  - cp -r /var/www/owncloud/web/tests/drone /srv/config
  - ls -la /srv/config/drone
  volumes:
  - name: configs
    path: /srv/config

- name: install-core
  pull: always
  image: owncloudci/core
  commands:
  - . /var/www/owncloud/web/.drone.env
  - export PLUGIN_GIT_REFERENCE=$CORE_COMMITID
  - bash /usr/sbin/plugin.sh
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-web-integration-app
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - mkdir apps-external/web
  - cp /srv/config/drone/config-oc10-integration-app-openid.json config/config.json
  - cp /var/www/owncloud/web/packages/web-integration-oc10/* apps-external/web -r
  - cp /var/www/owncloud/web/dist/* apps-external/web -r
  - ls -la apps-external/web
  - cat config/config.json
  volumes:
  - name: configs
    path: /srv/config

- name: setup-server-web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ a:e web
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set enable_previews --type=boolean --value=false
  - php occ config:system:set web.baseUrl --value="http://owncloud/index.php/apps/web"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: setup-oauth2
  pull: always
  image: owncloudci/php:7.4
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor
  - cd /var/www/owncloud/server/
  - php occ a:e oauth2
  - php occ oauth2:add-client Web Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://owncloud/index.php/apps/web/oidc-callback.html

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.4
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.4
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/web/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - ./tests/acceptance/run.sh
  environment:
    BACKEND_HOST: http://owncloud
    EXPECTED_FAILURES_FILE: /var/www/owncloud/web/tests/acceptance/expected-failures-with-oc10-server-oauth2-login-and-web-integration-app.md
    LOCAL_UPLOAD_DIR: /uploads
    SCREENSHOTS: true
    SERVER_HOST: http://owncloud/index.php/apps/web/index.html
    TEST_PATHS: "tests/acceptance/features/webUIMoveFilesFolders tests/acceptance/features/webUIResharing1 tests/acceptance/features/webUIResharing2 tests/acceptance/features/webUIResharingToRoot tests/acceptance/features/webUISharingAutocompletion tests/acceptance/features/webUISharingFilePermissionMultipleUsers tests/acceptance/features/webUISharingFilePermissionsGroups tests/acceptance/features/webUISharingFolderAdvancedPermissionMultipleUsers tests/acceptance/features/webUISharingFolderAdvancedPermissionsGroups tests/acceptance/features/webUISharingFolderPermissionMultipleUsers tests/acceptance/features/webUISharingFolderPermissionsGroups tests/acceptance/features/webUISharingInternalGroups tests/acceptance/features/webUISharingInternalGroupsEdgeCases tests/acceptance/features/webUISharingInternalGroupsSharingIndicator tests/acceptance/features/webUISharingInternalGroupsToRoot tests/acceptance/features/webUISharingInternalGroupsToRootEdgeCases tests/acceptance/features/webUISharingInternalGroupsToRootSharingIndicator tests/acceptance/features/webUISharingInternalUsers tests/acceptance/features/webUISharingInternalUsersExpire tests/acceptance/features/webUISharingInternalUsersCollaborator tests/acceptance/features/webUISharingInternalUsersShareWithPage tests/acceptance/features/webUISharingInternalUsersSharingIndicator tests/acceptance/features/webUISharingInternalUsersToRootCollaborator tests/acceptance/features/webUISharingInternalUsersToRootPreviews tests/acceptance/features/webUISharingInternalUsersToRootShareWithPage tests/acceptance/features/webUISharingInternalUsersToRootSharingIndicator tests/acceptance/features/webUISharingInternalUsersExpireToRoot tests/acceptance/features/webUISharingInternalUsersToRoot tests/acceptance/features/webUISharingInternalUsersToRootBlacklisted tests/acceptance/features/webUISharingPermissionsUsers tests/acceptance/features/webUISharingPermissionToRoot tests/acceptance/features/webUISharingPublicBasic tests/acceptance/features/webUISharingPublicManagement tests/acceptance/features/webUISharingPublicDifferentRoles tests/acceptance/features/webUISharingPublicExpire tests/acceptance/features/webUITrashbinDelete tests/acceptance/features/webUITrashbinFilesFolders tests/acceptance/features/webUITrashbinRestore tests/acceptance/features/webUIUpload "
    TEST_TAGS: not @skip and not @skipOnOC10 and not @openIdLogin and @smokeTest
    WEB_UI_CONFIG: /srv/config/drone/config-oc10-integration-app-oauth.json
  volumes:
  - name: gopath
    path: /srv/app
  - name: configs
    path: /srv/config

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    bucket: owncloud
    endpoint:
      from_secret: cache_s3_endpoint
    path_style: true
    source: /var/www/owncloud/web/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/web/tests/reports/screenshots
    target: /web/screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: cache_s3_access_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: cache_s3_secret_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/web/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>IntegrationApp2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> /var/www/owncloud/web/comments.file"
  - for f in *.png; do echo '!'"[$f]($CACHE_ENDPOINT/owncloud/web/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> /var/www/owncloud/web/comments.file; done
  - "echo \"\n</p></details>\" >> /var/www/owncloud/web/comments.file"
  - more /var/www/owncloud/web/comments.file
  environment:
    CACHE_ENDPOINT:
      from_secret: cache_s3_endpoint
    TEST_CONTEXT: IntegrationApp2
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/web/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: owncloud
  pull: always
  image: owncloudci/php:7.4
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: web
  pull: always
  image: owncloudci/php:7.4
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/web/dist

volumes:
- name: uploads
  temp: {}
- name: configs
  temp: {}
- name: gopath
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test
- changelog
- website

---
kind: pipeline
type: docker
name: build

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: web

steps:
- name: npm-install
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - yarn install --frozen-lockfile

- name: make
  pull: always
  image: owncloudci/nodejs:12
  commands:
  - cd /var/www/owncloud/web
  - make -f Makefile.release

- name: changelog
  pull: always
  image: toolhippie/calens:latest
  commands:
  - calens --version refs/heads/master -o dist/CHANGELOG.md -t changelog/CHANGELOG-Release.tmpl
  when:
    ref:
    - refs/tags/**

- name: publish
  pull: always
  image: plugins/github-release:1
  settings:
    api_key:
      from_secret: github_token
    checksum:
    - md5
    - sha256
    files:
    - release/*
    note: dist/CHANGELOG.md
    overwrite: true
    title: refs/heads/master
  when:
    ref:
    - refs/tags/**

- name: docker
  pull: always
  image: plugins/docker:18.09
  settings:
    auto_tag: true
    password:
      from_secret: docker_password
    repo: owncloud/web
    username:
      from_secret: docker_username
  when:
    ref:
      exclude:
      - refs/pull/**

trigger:
  ref:
  - refs/heads/master
  - refs/tags/**

depends_on:
- unit-tests
- cache-ocis
- webUIBasic-chrome
- webUICreate-chrome
- webUIDelete-chrome
- webUIRename-chrome
- webUISharingBasic-chrome
- Favorites-chrome
- MarkdownEditor-chrome
- webUIFiles1-chrome
- webUIFiles2-chrome
- Move-chrome
- webUIResharing-chrome
- ResharingToRoot-chrome
- RestrictSharing-chrome
- SharingAutocompletion-chrome
- SharingFilePermissionMultipleUsers-chrome
- SharingFilePermissionsGroups-chrome
- SharingFolderAdvancedPermissionMU-chrome
- SharingFolderAdvPermissionsGrp-chrome
- SharingFolderPermissionMultipleUsers-chrome
- SharingFolderPermissionsGroups-chrome
- SharingInternalGroups-chrome
- SharingInternalGroupsEdgeCases-chrome
- SharingInternalGroupsSharingIndicator-chrome
- SharingInternalGroupsRoot-chrome
- SharingInternalGroupsRootEdgeCases-chrome
- SharingInternalGroupsRootSharingIndicator-chrome
- webUISharingInternalUsers-chrome
- SharingInternalUsersBlacklisted-chrome
- SharingInternalUsersExpire-chrome
- SharingInternalUsersExpireToRoot-chrome
- SharingInternalUsersSharingIndicator-chrome
- webUISharingInternalUsersRoot1-chrome
- webUISharingInternalUsersRoot2-chrome
- SharingInternalUsersRootBlacklisted-chrome
- SharingInternalUsersRootSharingIndicator-chrome
- SharingPermissionsUsers-chrome
- SharingPermissionToRoot-chrome
- SharingPublicBasic-chrome
- SharingPublicManagement-chrome
- SharingPublicDifferentRoles-chrome
- SharingPublicExpire-chrome
- TrashbinDelete-chrome
- TrashbinFilesFolders-chrome
- TrashbinRestore-chrome
- Upload-chrome
- webUINotificationBasic-chrome
- webUISharingNotifications-chrome
- SharingExternal-chrome
- SharingExternalRoot-chrome
- XGAPortrait1-Notifications-chrome
- XGAPortrait1-chrome
- XGAPortrait2-chrome
- iPhone1-Notifications-chrome
- iPhone1-chrome
- iPhone2-chrome
- webUIOCISBasic-chrome
- webUIOCISCreate-chrome
- webUIOCISDelete-chrome
- webUIOCISRename-chrome
- webUIOCISSharingBasic-chrome
- webUIOCISRestrictSharing-chrome
- webUIOCISSharingNotifications-chrome
- OCISFavorites-chrome
- OCISMarkdownEditor-chrome
- webUIOCISFiles1-chrome
- webUIOCISFiles2-chrome
- webUIOCISFiles3-chrome
- OCISSharingAutocompletion-chrome
- OCISSharingInternalGroups-chrome
- OCISSharingInternalUsers1-chrome
- OCISSharingInternalUsers2-chrome
- OCISSharingInternalUsersExpire-chrome
- OCISSharingPermissionsUsers-chrome
- OCISSharingFilePermissionsGroups-chrome
- OCISSharingFolderPermissionsGroups-chrome
- OCISSharingFolderAdvPermissionsGrp-chrome
- OCISResharing1-chrome
- OCISResharing2-chrome
- OCISSharingPublicBasic-chrome
- OCISSharingPublicManagement-chrome
- OCISSharingPublicExpire-chrome
- OCISSharingPublicDifferentRoles-chrome
- OCISTrashbinDelete-chrome
- OCISTrashbinFilesFolders-chrome
- OCISTrashbinRestore-chrome
- OCISUpload-chrome
- OCISSharingFilePermissionMultipleUsers-chrome
- OCISSharingFolderPermissionMultipleUsers-chrome
- OCISSharingFolderAdvancedPermissionMU-chrome
- OCISMove-chrome
- OCISJourney-chrome
- oc10-integration-notifications-chrome
- IntegrationApp1-chrome
- IntegrationApp2-chrome

---
kind: pipeline
type: docker
name: chat-notifications

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: notify-rocketchat
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
    webhook:
      from_secret: private_rocketchat

trigger:
  ref:
  - refs/tags/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*
  status:
  - success
  - failure

depends_on:
- unit-tests
- cache-ocis
- webUIBasic-chrome
- webUICreate-chrome
- webUIDelete-chrome
- webUIRename-chrome
- webUISharingBasic-chrome
- Favorites-chrome
- MarkdownEditor-chrome
- webUIFiles1-chrome
- webUIFiles2-chrome
- Move-chrome
- webUIResharing-chrome
- ResharingToRoot-chrome
- RestrictSharing-chrome
- SharingAutocompletion-chrome
- SharingFilePermissionMultipleUsers-chrome
- SharingFilePermissionsGroups-chrome
- SharingFolderAdvancedPermissionMU-chrome
- SharingFolderAdvPermissionsGrp-chrome
- SharingFolderPermissionMultipleUsers-chrome
- SharingFolderPermissionsGroups-chrome
- SharingInternalGroups-chrome
- SharingInternalGroupsEdgeCases-chrome
- SharingInternalGroupsSharingIndicator-chrome
- SharingInternalGroupsRoot-chrome
- SharingInternalGroupsRootEdgeCases-chrome
- SharingInternalGroupsRootSharingIndicator-chrome
- webUISharingInternalUsers-chrome
- SharingInternalUsersBlacklisted-chrome
- SharingInternalUsersExpire-chrome
- SharingInternalUsersExpireToRoot-chrome
- SharingInternalUsersSharingIndicator-chrome
- webUISharingInternalUsersRoot1-chrome
- webUISharingInternalUsersRoot2-chrome
- SharingInternalUsersRootBlacklisted-chrome
- SharingInternalUsersRootSharingIndicator-chrome
- SharingPermissionsUsers-chrome
- SharingPermissionToRoot-chrome
- SharingPublicBasic-chrome
- SharingPublicManagement-chrome
- SharingPublicDifferentRoles-chrome
- SharingPublicExpire-chrome
- TrashbinDelete-chrome
- TrashbinFilesFolders-chrome
- TrashbinRestore-chrome
- Upload-chrome
- webUINotificationBasic-chrome
- webUISharingNotifications-chrome
- SharingExternal-chrome
- SharingExternalRoot-chrome
- XGAPortrait1-Notifications-chrome
- XGAPortrait1-chrome
- XGAPortrait2-chrome
- iPhone1-Notifications-chrome
- iPhone1-chrome
- iPhone2-chrome
- webUIOCISBasic-chrome
- webUIOCISCreate-chrome
- webUIOCISDelete-chrome
- webUIOCISRename-chrome
- webUIOCISSharingBasic-chrome
- webUIOCISRestrictSharing-chrome
- webUIOCISSharingNotifications-chrome
- OCISFavorites-chrome
- OCISMarkdownEditor-chrome
- webUIOCISFiles1-chrome
- webUIOCISFiles2-chrome
- webUIOCISFiles3-chrome
- OCISSharingAutocompletion-chrome
- OCISSharingInternalGroups-chrome
- OCISSharingInternalUsers1-chrome
- OCISSharingInternalUsers2-chrome
- OCISSharingInternalUsersExpire-chrome
- OCISSharingPermissionsUsers-chrome
- OCISSharingFilePermissionsGroups-chrome
- OCISSharingFolderPermissionsGroups-chrome
- OCISSharingFolderAdvPermissionsGrp-chrome
- OCISResharing1-chrome
- OCISResharing2-chrome
- OCISSharingPublicBasic-chrome
- OCISSharingPublicManagement-chrome
- OCISSharingPublicExpire-chrome
- OCISSharingPublicDifferentRoles-chrome
- OCISTrashbinDelete-chrome
- OCISTrashbinFilesFolders-chrome
- OCISTrashbinRestore-chrome
- OCISUpload-chrome
- OCISSharingFilePermissionMultipleUsers-chrome
- OCISSharingFolderPermissionMultipleUsers-chrome
- OCISSharingFolderAdvancedPermissionMU-chrome
- OCISMove-chrome
- OCISJourney-chrome
- oc10-integration-notifications-chrome
- IntegrationApp1-chrome
- IntegrationApp2-chrome

...
